const urlParams = new URLSearchParams(window.location.search);
const symbol = urlParams.get("symbol") || "BIST:THYAO";

function loadTradingViewWidget(symbol) {
    const widgetContainer = document.getElementById("tradingview_0");
    widgetContainer.innerHTML = "";

    const script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://s3.tradingview.com/external-embedding/embed-widget-symbol-info.js";
    script.async = true;

    script.innerHTML = JSON.stringify({
        "symbol": symbol,
        "width": "100%",
        "locale": "tr",
        "colorTheme": "light",
        "isTransparent": false
    });

    widgetContainer.appendChild(script);
}

function loadFinancialRatios(symbol) {
    fetch(`https://api.example.com/financials?symbol=${symbol}`)
        .then(response => response.json())
        .then(data => {
            const valuationBody = document.getElementById("valuationBody");
            valuationBody.innerHTML = '';

            const ratios = {
                "Kazanç Gücü Değeri": data.earningPowerValue,
                "TİM Çok Aşamalı": data.timMultiStage,
                "TİM Sabit Büyüme": data.timConstantGrowth,
                "Fiyat / Defter Değeri Oranı (PD/DD)": data.pdToDd,
                "FD / Gelir Oranı": data.fdToRevenue,
                "Fiyat / Satış Oranı": data.priceToSales,
                "Fiyat / Kazanç Oranı (F/K)": data.priceToEarnings,
                "FD / FAVÖK Oranı": data.fdToEbitda,
                "10Y İNA Büyüme Çıkışı": data.tenYearInaGrowth,
                "5Y İNA Büyüme Çıkışı": data.fiveYearInaGrowth,
                "10Y İNA FAVÖK Çıkışı": data.tenYearEbitdaGrowth,
                "FD / FAVÖK Oranı (Yeni)": data.fdToEbitdaNew,
                "5Y İNA Gelir Çıkışı": data.fiveYearRevenueGrowth,
                "10Y İNA Gelir Çıkışı": data.tenYearRevenueGrowth
            };

            for (const [key, value] of Object.entries(ratios)) {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${key}</td><td>${value}</td>`;
                valuationBody.appendChild(row);
            }

            document.getElementById("financialRatios").style.display = "table";
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Veri çekme sırasında bir hata oluştu. Lütfen sembolü kontrol edin.');
        });
}

if (symbol) {
    loadTradingViewWidget(symbol);
    loadFinancialRatios(symbol);
}

document.getElementById("symbolForm").addEventListener("submit", function(event) {
    event.preventDefault();
    const newSymbol = document.getElementById("symbolInput").value;
    loadTradingViewWidget(newSymbol);
    loadFinancialRatios(newSymbol);
});
